name: Production Release on Sprint Merge
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create-production-release:
    # Only run when PR is merged with specific title pattern
    if: |
      github.event.pull_request.merged == true && 
      startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout PROD branch with tags
      - name: Checkout PROD branch with tags
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git clone -b prod https://${{ secrets.SUNIL2_TOKEN }}@github.com/${{ github.repository }}.git .
          git fetch --tags
          git checkout main
          git pull origin main
          git fetch --tags
      
      # Step 2: Extract sprint number from PR title
      - name: Extract sprint number from PR title
        id: extract_sprint
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          SPRINT_NUMBER=$(echo "$PR_TITLE" | grep -o '[0-9]\+' | head -1)
          echo "SPRINT_NUMBER=$SPRINT_NUMBER" >> $GITHUB_ENV
          echo "Extracted sprint number: $SPRINT_NUMBER"
      
      # Step 3: Get latest sprint tag and increment
      - name: Get latest sprint tag and increment
        id: get_next_tag
        run: |
          # Get all sprint tags and find the highest number
          LATEST_SPRINT_TAG=$(git tag -l "sprint_*" | sort -V | tail -n 1)
          
          if [ -z "$LATEST_SPRINT_TAG" ]; then
            # No existing sprint tags, start from sprint number in PR
            NEXT_TAG="sprint_$SPRINT_NUMBER"
            echo "No existing sprint tags found. Using tag: $NEXT_TAG"
          else
            # Extract number from latest tag and increment
            LATEST_NUMBER=$(echo "$LATEST_SPRINT_TAG" | sed 's/sprint_//')
            NEXT_NUMBER=$((LATEST_NUMBER + 1))
            NEXT_TAG="sprint_${NEXT_NUMBER}"
            echo "Latest tag: $LATEST_SPRINT_TAG, Next tag: $NEXT_TAG"
          fi
          
          echo "NEXT_TAG=$NEXT_TAG" >> $GITHUB_ENV
          echo "Using tag: $NEXT_TAG"
      
      # Step 4: Create release using GitHub API with auto-generated notes
      - name: Create GitHub Release using API
        run: |
          RELEASE_JSON=$(cat << EOF
          {
            "tag_name": "$NEXT_TAG",
            "target_commitish": "main",
            "name": "Sprint Release $NEXT_TAG",
            "body": "## Release Information\n- **Sprint Number**: $SPRINT_NUMBER\n- **Release Branch**: main\n- **Auto-generated from**: ${{ github.event.pull_request.title }}\n\n## Changes\n*Release notes are automatically generated by GitHub*",
            "generate_release_notes": true,
            "draft": false,
            "prerelease": false
          }
          EOF
          )
          
          echo "Creating release with payload:"
          echo "$RELEASE_JSON"
          
          # Create release using GitHub API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: token ${{ secrets.SUNIL2_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "$RELEASE_JSON" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Response Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Failed to create release. HTTP Code: $HTTP_CODE"
            exit 1
          else
            RELEASE_URL=$(echo "$RESPONSE_BODY" | grep -o '"html_url":[^,]*' | cut -d'"' -f4)
            echo "Release created successfully: $RELEASE_URL"
          fi
